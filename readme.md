# arrest-peptide-DMS

NGS read processing and analysis scripts for deep mutational scanning (DMS)
of translational arrest peptides.

This repository documents a complete analysis pipeline used in our study.
For reproducibility of published results, the analysis can start from
demultiplexed FASTQ files deposited in public repositories (e.g. DRA).
For newly generated sequencing data, the full pipeline can also be executed
starting from raw FASTQ files, including checksum verification and
demultiplexing.

---

## Notes on data availability and reproducibility

Sequencing reads deposited in public repositories (e.g. DRA) correspond to
**demultiplexed FASTQ files**.
When using these data, the analysis starts from the *read quality filtering
and paired-end merging* step.

For newly generated sequencing data obtained directly from a sequencing
service, the full pipeline can be executed starting from raw FASTQ files,
including MD5 checksum verification and demultiplexing.

---

## Overview of starting points

Two entry points are supported:

1. **Demultiplexed FASTQ files (recommended for reproducing published results)**  
   - FASTQ files deposited in DRA  
   - Or FASTQ files generated by the demultiplexing step and stored in  
     `output/fastq_demultiplexed/`  
   - Pipeline starts from *read quality filtering and paired-end merging*

2. **Raw FASTQ files from a sequencing service (for new experiments)**  
   - Paired-end FASTQ files placed in `input/`  
   - Full pipeline starts from MD5 checksum verification

---

## Directory structure (recommended)
```
.
├── input/
│   ├── *_read_1.fq.gz
│   ├── *_read_2.fq.gz
│   ├── md5.txt
│   ├── sample_sheet.csv
│   └── plot_order.csv
├── scripts/
│   ├── check_md5sum.R
│   ├── Demultiplexing.sh
│   ├── MergeReads.sh
│   ├── PrepPattern_NNK.R
│   ├── PrepPattern_NNN.R
│   ├── calc_change.R
│   └── summarize.R
└── output/
├── fastq_demultiplexed/
├── fastq_merged/
├── ptn/
├── calc/
└── fig/
```
---

## Sample sheet (`input/sample_sheet.csv`)

The pipeline uses a single sample sheet (`CSV` format) that is shared across
all steps. Required columns increase progressively in downstream analyses.

### Column definitions

| Column name | Description |
|---|---|
| `#sample_number` | Sample identifier. Lines starting with `#` are treated as comments in shell scripts. |
| `bc5` | 5′ barcode sequence (metadata; not used for demultiplexing). |
| `bc7` | Barcode sequence used for demultiplexing, expected at positions 7–9 of read_2. |
| `sample_name` | Sample name used for directory and file naming. |
| `read_exp` | Read experiment identifier (used for bookkeeping). |
| `lib_len` | Length of the library sequence located **between `bc5` and `bc7`** (barcode sequences excluded); used for merged read length filtering (`fastp -l`). |
| `target` | Name of the arrest peptide (DMS target) analyzed in this experiment. |
| `organism` | Organism name (metadata, used in downstream summaries). |
| `antibiotic` | Antibiotic used during selection. |
| `conc_antibiotic` | Antibiotic concentration used as a condition variable. |
| `time` | Time point identifier (e.g. `t0`, `t1`). |
| `rep_cell_lib` | Replicate identifier for cell libraries. |
| `rep_selection` | Replicate identifier for selection experiments. |
| `rep_DNA_lib` | Replicate identifier for DNA libraries. |
| `cfu` | Colony-forming units used for growth-rate calculations. |
| `culture_min` | Culture time (minutes) used for growth-rate normalization. |
| `reads_pe1` | File name of the raw paired-end read 1 FASTQ file (e.g. `*_1.fq.gz`). |
| `reads_pe2` | File name of the raw paired-end read 2 FASTQ file (e.g. `*_2.fq.gz`). |

### Notes

- Lines starting with `#` are ignored by shell scripts and can be used for comments.
- The same sample sheet is used throughout the pipeline; however, only a subset
  of columns is required at early steps (e.g. demultiplexing).
- `reads_pe1` and `reads_pe2` are recorded for provenance tracking and are not
  directly consumed by downstream scripts.

---

## 0. Preparation

- Place raw paired-end FASTQ files (`*_read_1.fq.gz`, `*_read_2.fq.gz`) in `input/`  
- Place the checksum file (`md5.txt`) provided by the sequencing service in `input/`  
- Prepare `input/sample_sheet.csv`  
- (Optional) Prepare `input/plot_order.csv` to control heatmap ordering  

---

## 1. MD5 checksum verification (optional)

**Required only when starting from raw FASTQ files obtained directly from a
sequencing service.**

Script:  
- `check_md5sum.R`

Example:
```
cd /path/to/project
Rscript scripts/check_md5sum.R \
  input/sample_read_1.fq.gz \
  input/sample_read_2.fq.gz \
  input/md5.txt
```

⸻

## 2. Demultiplexing (optional)

Not required when using demultiplexed FASTQ files deposited in DRA.

Script:  
- Demultiplexing.sh 

Description:  
- Barcodes (bc7) are expected at positions 7–9 of read_2   
- Reads are split using seqkit split, assigned to samples, and re-paired.  

Output:
```
output/fastq_demultiplexed/<sample_name>/
  ├── <sample_name>_read_1.fq.gz
  └── <sample_name>_read_2.fq.gz
```
Example:
```
zsh scripts/Demultiplexing.sh \
  input/sample_read_1.fq.gz \
  input/sample_read_2.fq.gz \
  input/sample_sheet.csv
```

⸻

## 3. Read quality filtering and paired-end merging

Standard starting point when using demultiplexed FASTQ files.

Script:
- MergeReads.sh

Input:
- output/fastq_demultiplexed/<sample_name>/*_read_1.fq.gz
- output/fastq_demultiplexed/<sample_name>/*_read_2.fq.gz

Output:
- output/fastq_merged/<output_dir>/
- merged, unpaired FASTQs
- fastp HTML/JSON reports

Example:
```
zsh scripts/MergeReads.sh \
  -s input/sample_sheet.csv \
  -o qc1 \
  -q 20 \
  -u 30 \
  -e 25 \
  -n 5
```

⸻

## 4. Preparation of DMS mutant pattern list

Scripts:
- PrepPattern_NNK.R
- PrepPattern_NNN.R

Note: Either NNK or NNN is used depending on library design.

Example:
```
Rscript scripts/PrepPattern_NNK.R \
  TARGET_NAME \
  WILD_TYPE_SEQUENCE \
  output/ptn/ptn_TARGET_NNK.csv
```

⸻

## 5. Growth rate estimation

Script:
- calc_change.R

Description:
Maps merged reads to the DMS pattern list and calculates growth-rate–based
metrics for each mutant.
In the current implementation, this step focuses on estimating **growth rate
(GR)** from read counts and experimental metadata.
Fitness values relative to control conditions are derived in the subsequent
plotting and summarization step.

Output:
- output/calc/<input_dir>/
- RPM_<output_suffix>.csv
- GR_<output_suffix>.csv
- GR_<output_suffix>_removed.csv
- GR_<output_suffix>_missing.csv

Example:
```
Rscript scripts/calc_change.R \
  output/ptn/ptn_TARGET_NNK.csv \
  UPSTREAM_SEQ \
  DOWNSTREAM_SEQ \
  qc1 \
  TARGET_NAME \
  8 \
  input/sample_sheet.csv
```

⸻

## 6. Visualization and summary

Script:
- summarize.R

Description:
Generates summary plots from growth-rate tables produced in Step 5 and
**derives fitness values by comparing growth rates between baseline and
treated conditions**.
This step produces reproducibility plots and heatmaps at codon and
amino-acid levels.

Output:
- PDF figures in output/fig/
- Source CSV for fitness heatmaps

Example:
```
Rscript scripts/summarize.R \
  TARGET_NAME \
  38 \
  77 \
  output/calc/qc1/GR_TARGET_NAME.csv \
  output/ptn/ptn_TARGET_NNK.csv \
  qc1
```

⸻

## Software requirements (tested versions)
- fastp v0.24.0
- SeqKit v2.10.0
- R v4.5.0

## R packages:
- tidyverse v2.0.0
- Biostrings v2.76.0
- ShortRead v1.66.0
- gtools v3.9.5
- ggthemes v5.1.0
- patchwork v1.3.2

⸻

## Notes for reuse

This pipeline is provided as a reference implementation.
Differences in library design, sequencing strategy, or data deposition
may require modifications by individual users.

---
