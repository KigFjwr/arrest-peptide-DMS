# arrest-peptide-dms

NGS read processing and analysis scripts for deep mutational scanning (DMS)
of translational arrest peptides.

This repository documents a complete analysis pipeline for DMS experiments.
For reproducibility of published results, the analysis can start from
demultiplexed FASTQ files deposited in public repositories (e.g. DRA).
For newly generated sequencing data, the full pipeline can also be executed
starting from raw FASTQ files, including checksum verification and
demultiplexing.

---

## Notes on data availability and reproducibility

Sequencing reads deposited in public repositories (e.g. DRA) correspond to
**demultiplexed FASTQ files**.
When using these data, the analysis starts from the *read quality filtering
and merging* step.

For newly generated sequencing data obtained directly from a sequencing
service, the full pipeline can be executed starting from raw FASTQ files,
including MD5 checksum verification and demultiplexing.

---

## Overview of starting points

Two entry points are supported:

1. **Demultiplexed FASTQ files (recommended for reproducing published results)**  
   - FASTQ files deposited in DRA
   - Or FASTQ files generated by the demultiplexing step and stored in  
     `output/fastq_demultiplexed/`
   - Pipeline starts from *read quality filtering and merging*

2. **Raw FASTQ files from a sequencing service (for new experiments)**  
   - Paired-end FASTQ files placed in `input/`
   - Full pipeline starts from MD5 checksum verification

---

## Directory structure (recommended)

.
├── input/
│   ├── *_read_1.fq.gz
│   ├── *_read_2.fq.gz
│   ├── md5.txt
│   └── sample_sheet_read_proc.csv
├── scripts/
│   ├── check_md5sum.R
│   ├── Demultiplexing.sh
│   ├── MergeReads.sh
│   ├── PrepPattern_NNK.R
│   ├── PrepPattern_NNN.R
│   ├── calc_change.R
│   └── summarize.R
└── output/
├── fastq_demultiplexed/
├── ptn/
├── calc/
└── figures/

---

## 0. Preparation

- Place raw paired-end FASTQ files  
  (`*_read_1.fq.gz`, `*_read_2.fq.gz`) in the `input/` directory
- Place the checksum file (`md5.txt`) provided by the sequencing service
  in `input/`
- Prepare `sample_sheet_read_proc.csv` and place it in `input/`

**Note**  
The last column of `sample_sheet_read_proc.csv` must be named `read_exp`.

---

## 1. MD5 checksum verification (optional)

**Required only when starting from raw FASTQ files obtained directly from
a sequencing service.**

Script:  
- `check_md5sum.R`

Description:  
Verifies the integrity of downloaded FASTQ files using the checksum file
provided by the sequencing service.

Example:
```bash
cd /path/to/project
Rscript scripts/check_md5sum.R \
  input/sample_read_1.fq.gz \
  input/sample_read_2.fq.gz \
  input/md5.txt


⸻

2. Demultiplexing (optional)

Not required when using demultiplexed FASTQ files deposited in DRA or
already present in output/fastq_demultiplexed/.

Script:
	•	Demultiplexing.sh

Description:
Demultiplexes raw paired-end reads based on sample-specific barcodes defined
in sample_sheet_read_proc.csv.

Output:
	•	Demultiplexed FASTQ files are written to
output/fastq_demultiplexed/

Notes:
	•	Barcode matching rules and mismatch tolerance are defined in the script.
	•	Intermediate files generated during demultiplexing can be removed after
verification.

Example:

cd /path/to/project
zsh scripts/Demultiplexing.sh \
  input/sample_read_1.fq.gz \
  input/sample_read_2.fq.gz \
  input/sample_sheet_read_proc.csv


⸻

3. Read quality filtering and paired-end merging

This is the standard starting point when using demultiplexed FASTQ files
from DRA or from output/fastq_demultiplexed/.

Script:
	•	MergeReads.sh

Input:
	•	Demultiplexed FASTQ files in output/fastq_demultiplexed/

Description:
Performs quality filtering and paired-end read merging using fastp.
Quality thresholds are explicitly specified to ensure reproducibility.

Example:

cd /path/to/project
zsh scripts/MergeReads.sh \
  -s input/sample_sheet_read_proc.csv \
  -o qc1 \
  -q 20 \
  -u 30 \
  -e 25 \
  -n 5


⸻

4. Preparation of DMS mutant pattern list

Scripts:
	•	PrepPattern_NNK.R
	•	PrepPattern_NNN.R

Description:
Generates a list of expected mutant sequences for DMS libraries based on
a wild-type nucleotide sequence.

Note
Depending on the library design, either NNK or NNN is used.
These scripts are alternatives and should not be used sequentially
for the same dataset.

Example:

cd /path/to/project
Rscript scripts/PrepPattern_NNK.R \
  TARGET_NAME \
  WILD_TYPE_SEQUENCE \
  output/ptn/ptn_TARGET_NNK.csv


⸻

5. Fitness calculation

Script:
	•	calc_change.R

Description:
Calculates fitness changes for each mutant based on read counts obtained
after quality filtering and merging.

Example:

cd /path/to/project
Rscript scripts/calc_change.R \
  output/ptn/ptn_TARGET_NNK.csv \
  UPSTREAM_SEQUENCE \
  DOWNSTREAM_SEQUENCE \
  qc1 \
  TARGET_NAME \
  8 \
  input/sample_sheet_read_proc.csv


⸻

6. Visualization and summary

Script:
	•	summarize.R

Description:
Summarizes DMS results and generates plots.

Example:

cd /path/to/project
Rscript scripts/summarize.R \
  TARGET_NAME \
  START_POSITION \
  END_POSITION \
  output/calc/qc1/GR_TARGET_NAME.csv \
  output/ptn/ptn_TARGET_NNK.csv \
  qc1


⸻

Software requirements (tested versions)
	•	fastp v0.24.0
	•	SeqKit v2.10.0
	•	R v4.5.0

R packages:
	•	tidyverse v2.0.0
	•	Biostrings v2.76.0
	•	ShortRead v1.66.0
	•	gtools v3.9.5
	•	ggthemes v5.1.0
	•	patchwork v1.3.2

⸻

Notes for reuse

This pipeline is provided as a reference implementation.
Differences in library design, sequencing strategy, or data deposition
may require modifications by individual users.

